import {
  CodeSurfer,
  CodeSurferColumns,
  Step,
} from "code-surfer";
import { github, vsDark } from "@code-surfer/themes";
import { Layout } from "./Layout";

export const theme = vsDark;

# ã‚¼ãƒ­ã‹ã‚‰ç†è§£ã™ã‚‹Redux

---

# è‡ªå·±ç´¹ä»‹

- ä¼Šè—¤å‹å“‰
- æ±å·¥å¤§B5
- 2018/9ã‹ã‚‰React&ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°å§‹ã‚ãŸ
- twitter: [@yuyaito_hoge](https://twitter.com/yuyaito_hoge)

---

Redux...ä½¿ã£ã¦ã„ã¾ã™ã‹?

---

Redux ã¨ã¯

<iframe
  style={{
    width: "90vw",
    height: "75vh",
    background: "white",
  }}
  src={"https://redux.js.org/"}
></iframe>

---

# Pros

1. ãƒ†ã‚¹ã‚¿ãƒ“ãƒªãƒ†ã‚£ãŒé«˜ã„
1. é–‹ç™ºè€…ãŒå¢—ãˆã¦ã‚‚ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆãŒèµ·ãã¥ã‚‰ã„
1. Contextãƒã‚¹ãƒˆåœ°ç„, Propsãƒã‚±ãƒ„ãƒªãƒ¬ãƒ¼åœ°ç„ãŒæ¶ˆãˆã‚‹

---

# Cons

1. ã‚³ãƒ¼ãƒ‰ãŒå†—é•·ã«ãªã‚ŠãŒã¡
1. æ›¸ã„ã¦ã¦æ¥½ã—ããªã„()

---

ã‚ˆãã‚ã‚‹ã‚³ãƒ¼ãƒ‰

---

<CodeSurferColumns themes={[vsDark, github]}>

<Step>

```js title="ã‚¢ã‚¯ã‚·ãƒ§ãƒ³"
export const ageChanged = (age) => {
    return {
        type: AGE_CHANGED,
        payload: age
    };
};
```

```js title="ãƒªãƒ‡ãƒ¥ãƒ¼ã‚µãƒ¼" 
switch (action.type) {
  case AGE_CHANGED:
      return { ...state, age: action.payload };
  default:
      return state;
}
```

</Step>

<Step>

```js title="ã‚¢ã‚¯ã‚·ãƒ§ãƒ³"
export const sexChanged = (sex) => {
    return {
        type: SEX_CHANGED,
        payload: sex
    };
};

export const ageChanged = (age) => {
    return {
        type: AGE_CHANGED,
        payload: age
    };
};
```

```js title="ãƒªãƒ‡ãƒ¥ãƒ¼ã‚µãƒ¼"
switch (action.type) {
  case SEX_CHANGED:
      return { ...state, male: action.payload };
  case AGE_CHANGED:
      return { ...state, age: action.payload };
  default:
      return state;
}
```

</Step>

<Step>

```js title="ã‚¢ã‚¯ã‚·ãƒ§ãƒ³"
export const sexChanged = (sex) => {
    return {
        type: SEX_CHANGED,
        payload: sex
    };
};

export const ageChanged = (age) => {
    return {
        type: AGE_CHANGED,
        payload: age
    };
};

export const regionChanged = (text) => {
    console.log(text)
    return {
        type: REGION_CHANGED,
        payload: text
    };
};

```

```js title="ãƒªãƒ‡ãƒ¥ãƒ¼ã‚µãƒ¼"
switch (action.type) {
  case SEX_CHANGED:
      return { ...state, male: action.payload };
  case AGE_CHANGED:
      return { ...state, age: action.payload };
  case REGION_CHANGED:
      return { ...state, region: action.payload };
  default:
      return state;
}
```

</Step>

<Step>

```js title="ã‚¢ã‚¯ã‚·ãƒ§ãƒ³"
export const sexChanged = (sex) => {
    return {
        type: SEX_CHANGED,
        payload: sex
    };
};

export const ageChanged = (age) => {
    return {
        type: AGE_CHANGED,
        payload: age
    };
};

export const regionChanged = (text) => {
    console.log(text)
    return {
        type: REGION_CHANGED,
        payload: text
    };
};

export const nameChanged = (text) => {
    return {
        type: NAME_CHANGED,
        payload: text
    };
};

export const profileChanged = (text) => {
    return {
        type: PROFILE_CHANGED,
        payload: text
    };
};

export const profileImageChanged = (image) => {
    return {
        type: PROFILEIMAGE_CHANGED,
        payload: image
    };
};

export const snackChanged = (text) => {
    return {
        type: SNACK_CHANGED,
        payload: text
    };
};
```

```js title="ãƒªãƒ‡ãƒ¥ãƒ¼ã‚µãƒ¼"
switch (action.type) {
  case SEX_CHANGED:
      return { ...state, male: action.payload };
  case AGE_CHANGED:
      return { ...state, age: action.payload };
  case REGION_CHANGED:
      return { ...state, region: action.payload };
  case NAME_CHANGED:
      return { ...state, name: action.payload };
  case PROFILE_CHANGED:
      return { ...state, profile: action.payload };
  case PROFILEIMAGE_CHANGED:
      return { ...state, profileImage: action.payload };
  case SNACK_CHANGED:
      return { ...state, snack: action.payload };
  case IMAGE_UPLOAD_START:
      return { ...state, imageUpoading: true};
  case IMAGE_UPLOAD_FINISH:
      return {...state, imageUploading: false}
  case PROFILE_FINISH:
      return {...state, updateLoading: true, imageUploading: true};
  case PROFILE_FINISH_SUCCESS:
      return {...state, updateLoading: false};
  case PROFILE_GET_FAIL:
      return {...state, loading:true}
  default:
      return state;
}
```

</Step>

</CodeSurferColumns>

---

# ãªã‚“ã‹å†—é•·ğŸ˜¢

---

#### Context APIã§Reduxã‹ã‚‰é€ƒã’ãŸã„!

---

<CodeSurfer>

```jsx title="ã¨ã‚ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ"
import React, { useState, useEffect, createContext } from "react"
import styled from "styled-components"
import { Main } from "./main"
import { Button } from "../util/Button"

const Wrapper = styled.div`
  margin: 1rem 0 0 0;
  padding-top: 3rem;
  width: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
`

const ButtonWrapper = styled.div`
  flex-direction: row;
  padding: 2rem;
`

const NavButton = styled(Button)`
  margin: 0 2rem;
`

export const IdContext = createContext(null)
export const fileNameContext = createContext(null)
export const clickContext = createContext(null)

export const Annotation = ({ match }) => {
  const [index, setIndex] = useState(0)
  const [data, setData] = useState(null)
  const [fetchSuccess, setFetchSuccess] = useState(false)
  useEffect(() => {
    // ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚§ãƒƒãƒ
    const fetchData = async id => {
      const res = await fetch("http://localhost:3333/db?id=" + id)
      const result = await res.json()
      setData(result)
      setFetchSuccess(true)
    }

    fetchData(match.params.id)
  }, [match.params.id, index])

  const preImage = () => {
    index !== 0 && setIndex(index - 1)
  }

  const nextImage = () => {
    index !== data.data.length - 1 && setIndex(index + 1)
  }

  if (!fetchSuccess)
    return (
      <Wrapper>
        <h1>Loading...</h1>
      </Wrapper>
    )
  return (
    <Wrapper>
      <h1>Select all squares with {data.task}</h1>
      <ButtonWrapper>
        {index !== 0 && (
          <NavButton onClick={() => setIndex(index - 1)}>å‰ã¸</NavButton>
        )}
        {index !== data.data.length - 1 && (
          <NavButton onClick={() => setIndex(index + 1)}>æ¬¡ã¸</NavButton>
        )}
      </ButtonWrapper>
    </Wrapper>
  )
}
```

```jsx subtitle="Provideråœ°ç„ğŸ˜–"
import React, { useState, useEffect, createContext } from "react"
import styled from "styled-components"
import { Main } from "./main"
import { Button } from "../util/Button"

const Wrapper = styled.div`
  margin: 1rem 0 0 0;
  padding-top: 3rem;
  width: 100%;
  display: flex;
  flex-direction: column;
  align-items: center;
`

const ButtonWrapper = styled.div`
  flex-direction: row;
  padding: 2rem;
`

const NavButton = styled(Button)`
  margin: 0 2rem;
`

export const IdContext = createContext(null)
export const fileNameContext = createContext(null)
export const clickContext = createContext(null)

export const Annotation = ({ match }) => {
  const [index, setIndex] = useState(0)
  const [data, setData] = useState(null)
  const [fetchSuccess, setFetchSuccess] = useState(false)
  useEffect(() => {
    // ç”»åƒãƒ‡ãƒ¼ã‚¿ã‚’ãƒ•ã‚§ãƒƒãƒ
    const fetchData = async id => {
      const res = await fetch("http://localhost:3333/db?id=" + id)
      const result = await res.json()
      setData(result)
      setFetchSuccess(true)
    }

    fetchData(match.params.id)
  }, [match.params.id, index])

  const preImage = () => {
    index !== 0 && setIndex(index - 1)
  }

  const nextImage = () => {
    index !== data.data.length - 1 && setIndex(index + 1)
  }

  if (!fetchSuccess)
    return (
      <Wrapper>
        <h1>Loading...</h1>
      </Wrapper>
    )
  return (
    <Wrapper>
      <h1>Select all squares with {data.task}</h1>
      <IdContext.Provider value={match.params.id}>
        <fileNameContext.Provider value={data.data[index].originalname}>
          <clickContext.Provider value={data.images[index].regions}>
            <Main
              // hoge
            />
          </clickContext.Provider>
        </fileNameContext.Provider>
      </IdContext.Provider>
      <ButtonWrapper>
        {index !== 0 && (
          <NavButton onClick={() => setIndex(index - 1)}>å‰ã¸</NavButton>
        )}
        {index !== data.data.length - 1 && (
          <NavButton onClick={() => setIndex(index + 1)}>æ¬¡ã¸</NavButton>
        )}
      </ButtonWrapper>
    </Wrapper>
  )
}
```

</CodeSurfer>

---

# Reduxã‚’ã¿ã‚‹ã¨

---

<CodeSurfer>

```js title="ã‚¢ã‚¯ã‚·ãƒ§ãƒ³"
export const sexChanged = (sex) => {
    return {
        type: SEX_CHANGED,
        payload: sex
    };
};
```

```js subtitle="ã»ã‚“ã¨ã«ã“ã‚Œã§ã„ã„ã®ã‹ã€‚ã€‚ã€‚ï¼Ÿ"
export const sexChanged = (sex) => {
    return {
        type: SEX_CHANGED,
        payload: sex
    };
};

export const ageChanged = (age) => {
    return {
        type: AGE_CHANGED,
        payload: age
    };
};

export const regionChanged = (text) => {
    console.log(text)
    return {
        type: REGION_CHANGED,
        payload: text
    };
};

export const nameChanged = (text) => {
    return {
        type: NAME_CHANGED,
        payload: text
    };
};

export const profileChanged = (text) => {
    return {
        type: PROFILE_CHANGED,
        payload: text
    };
};

export const profileImageChanged = (image) => {
    return {
        type: PROFILEIMAGE_CHANGED,
        payload: image
    };
};

export const snackChanged = (text) => {
    return {
        type: SNACK_CHANGED,
        payload: text
    };
};
```

</CodeSurfer>

---

### Reduxä½œè€…ã®Danæ°ã®ãƒ„ã‚¤ãƒ¼ãƒˆ

<Layout>

If you copy paste some action creators and reducers handling FETCH actions over and over and over again, youâ€™re probably using Redux in a different way than I imagined people would do. 
(ã‚‚ã—ã‚‚ä½•åº¦ã‚‚åŒã˜ã‚ˆã†ãªFETCHã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚³ãƒ”ãƒšã—ã¦ã‚‹ãªã‚‰ã€ãã‚“ãªãµã†ã«ä½¿ã‚ã‚Œã‚‹ãªã‚“ã¦æƒ³å®šã—ã¦ãªã‹ã£ãŸã‚“ã )

Iâ€™m sorry for all the repetitive code you felt you needed to write. Thatâ€™s my fault.
(**åŒã˜ã‚ˆã†ã«ä½•åº¦ã‚‚æ›¸ã‹ã‚ŒãŸã‚³ãƒ¼ãƒ‰ãŸã¡**ã‚ˆã€ã»ã‚“ã¨ã”ã‚ã‚“ã€‚ä¿ºã®ã›ã„ã ã€‚)

[ã‚½ãƒ¼ã‚¹](https://twitter.com/dan_abramov/status/1039584557702553601)
</Layout>

---

ğŸ˜‚

---

### Reduxä½œè€…ã®Danæ°ã®ãƒ„ã‚¤ãƒ¼ãƒˆ

<Layout>

My biggest regret with Redux is explaining it in terms of API instead of how to â€œthink in itâ€.
(Reduxã¯**API**ã¨ã—ã¦ã§ãªãã€**è€ƒãˆæ–¹**ã¨ã—ã¦èª¬æ˜ã™ã‚‹ã¹ãã ã£ãŸ)

I underestimated the temptation to twist it into a familiar conceptual model â€” and that itâ€™s flexible enough to allow these contortions.
(ã¿ã‚“ãªãŒè‡ªåˆ†ãŒçŸ¥ã£ã¦ã‚‹æ¦‚å¿µã«ã“ã‚“ãªã«ã‚‚ç„¡ç†ã‚„ã‚ŠReduxã‚’çµã³ã¤ã‘ãŸãŒã‚‹ãªã‚“ã¦ã€æ€ã„ã‚‚ã—ãªã‹ã£ãŸ)

[ã‚½ãƒ¼ã‚¹](https://twitter.com/dan_abramov/status/1039570011986321408)
</Layout>

---

## Reduxã¯APIã§ã¯ãªãè€ƒãˆæ–¹ã¨ãªğŸ¤”

---

## ãã‚“ãªæŠ˜ã«Danæ°ã®è§£èª¬è¬›åº§ã‚’[egghead.io](https://egghead.io/courses/getting-started-with-redux)ã§ç™ºè¦‹ğŸ’¡

---

## ç´¹ä»‹ã‚’å…¼ã­ã¦Reduxã‚’ã•ã‚ã‚Šã ã‘ä½œã£ã¦ã„ãã¾ã™â˜º

---

<CodeSurfer>

```html title="Official Counter Sample"
<!DOCTYPE html>
<html>
  <head>
    <title>Redux basic example</title>
  </head>
  <body>
    <div>
      <p>
        Clicked: <span id="value">0</span> times
        <button id="increment">+</button>
        <button id="decrement">-</button>
        <button id="incrementIfOdd">Increment if odd</button>
        <button id="incrementAsync">Increment async</button>
      </p>
    </div>
    <script>
      function counter(state, action) {
        if (typeof state === 'undefined') {
          return 0
        }
        switch (action.type) {
          case 'INCREMENT':
            return state + 1
          case 'DECREMENT':
            return state - 1
          default:
            return state
        }
      }
      var store = Redux.createStore(counter)
      var valueEl = document.getElementById('value')
      function render() {
        valueEl.innerHTML = store.getState().toString()
      }
      render()
      store.subscribe(render)
      document.getElementById('increment')
        .addEventListener('click', function () {
          store.dispatch({ type: 'INCREMENT' })
        })
      document.getElementById('decrement')
        .addEventListener('click', function () {
          store.dispatch({ type: 'DECREMENT' })
        })
      document.getElementById('incrementIfOdd')
        .addEventListener('click', function () {
          if (store.getState() % 2 !== 0) {
            store.dispatch({ type: 'INCREMENT' })
          }
        })
      document.getElementById('incrementAsync')
        .addEventListener('click', function () {
          setTimeout(function () {
            store.dispatch({ type: 'INCREMENT' })
          }, 1000)
        })
    </script>
  </body>
</html>
```

```html subtitle="ã“ã“ã‚’è‡ªå‰å®Ÿè£…ã«å¤‰ãˆã‚‹"
<!DOCTYPE html>
<html>
  <head>
    <title>Redux basic example</title>
    <script src="https://unpkg.com/redux@latest/dist/redux.min.js"></script>
  </head>
  <body>
    <div>
      <p>
        Clicked: <span id="value">0</span> times
        <button id="increment">+</button>
        <button id="decrement">-</button>
        <button id="incrementIfOdd">Increment if odd</button>
        <button id="incrementAsync">Increment async</button>
      </p>
    </div>
    <script>
      function counter(state, action) {
        if (typeof state === 'undefined') {
          return 0
        }
        switch (action.type) {
          case 'INCREMENT':
            return state + 1
          case 'DECREMENT':
            return state - 1
          default:
            return state
        }
      }
      var store = Redux.createStore(counter)
      var valueEl = document.getElementById('value')
      function render() {
        valueEl.innerHTML = store.getState().toString()
      }
      render()
      store.subscribe(render)
      document.getElementById('increment')
        .addEventListener('click', function () {
          store.dispatch({ type: 'INCREMENT' })
        })
      document.getElementById('decrement')
        .addEventListener('click', function () {
          store.dispatch({ type: 'DECREMENT' })
        })
      document.getElementById('incrementIfOdd')
        .addEventListener('click', function () {
          if (store.getState() % 2 !== 0) {
            store.dispatch({ type: 'INCREMENT' })
          }
        })
      document.getElementById('incrementAsync')
        .addEventListener('click', function () {
          setTimeout(function () {
            store.dispatch({ type: 'INCREMENT' })
          }, 1000)
        })
    </script>
  </body>
</html>
```

```diff 31[19:44],34[29:45],37,40 title="ä»Šå›å®Ÿè£…ã™ã‚‹Reduxé–¢é€£ãƒ¡ã‚½ãƒƒãƒ‰ãŸã¡"

```

```diff 18:30 title="Reducer" subtitle="Reducerã¯ãƒ”ãƒ¥ã‚¢ãªJavascript"

```

```diff 31 title="createStore" subtitle="createStoreã¯reducerã‚’å—ã‘å–ã‚Šstoreã‚’è¿”ã™"

```

```diff 34[29:44] title="getState" subtitle="getStateã¯ç¾åœ¨ã®stateå€¤ã‚’è¿”ã™"

```

```diff 34[29:44],18:30 subtitle="stateã¯reducerå†…ã§å®šç¾©ã•ã‚Œã¦ã„ã‚‹"

```

```diff 37 title="subscribe" subtitle="subscribeã¯stateãŒæ›´æ–°ã•ã‚Œã‚‹ã”ã¨ã«renderã‚’ç™ºç«ã•ã›ã‚‹"

```

```diff 37,33:35 title="render"

```

```diff 37,32:35 title="render" subtitle="renderã¯stateå€¤ã‚’id="value"ã‚’æŒã¤DOMè¦ç´ ã«æ›¸ãè¾¼ã‚€"

```

```diff 40 title="dispatch" subtitle="dispatchã¯actionã‚’reducerã«æ¸¡ã™"

```

```diff 31[19:44],34[29:45],37,40 title="ä»Šå›å®Ÿè£…ã™ã‚‹Reduxé–¢é€£ãƒ¡ã‚½ãƒƒãƒ‰ãŸã¡"

```

```diff 31[19:44],34[29:45],37,40 title="ä»Šå›å®Ÿè£…ã™ã‚‹Reduxé–¢é€£ãƒ¡ã‚½ãƒƒãƒ‰ãŸã¡" subtitle="ã“ã“ã‹ã‚‰ã¯å®Ÿéš›ã«ã‚³ãƒ¼ãƒ‰ã‚’æ›¸ã„ã¦ã„ã"

```

</CodeSurfer>

---

## [Coding](https://jsbin.com/yuguhi/3/edit?js,output)...ğŸ‘¨â€ğŸ’»

---

## ã¾ã¨ã‚
- Reduxã®ã‚‚ã£ã¨ã‚‚ã‚·ãƒ³ãƒ—ãƒ«ãªå®Ÿè£…ã‚’ã—ãŸ
- Reduxã¨ä»²è‰¯ããªã‚ŒãŸæ°—ãŒã—ãŸğŸ˜

---

ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸğŸ™
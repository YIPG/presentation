import {
  CodeSurfer,
  CodeSurferColumns,
  Step,
} from "code-surfer";
import { github, vsDark } from "@code-surfer/themes";
import { Layout } from "./Layout";

export const theme = vsDark;

# ã‚¼ãƒ­ã‹ã‚‰ç†è§£ã™ã‚‹ redux

---

# è‡ªå·±ç´¹ä»‹

- ä¼Šè—¤å‹å“‰
- æ±å·¥å¤§ B4
- 2018/9 ã‹ã‚‰ React è§¦ã‚Šå§‹ã‚ãŸ

---

Redux...ä½¿ã£ã¦ã„ã¾ã™ã‹?

---

Redux ã¨ã¯

<iframe
  style={{
    width: "90vw",
    height: "75vh",
    background: "white",
  }}
  src={"https://redux.js.org/"}
></iframe>

---

ã‚ˆãã‚ã‚‹ã‚³ãƒ¼ãƒ‰

---

<CodeSurferColumns themes={[vsDark, github]}>

<Step>

```js title="ã‚¢ã‚¯ã‚·ãƒ§ãƒ³"
export const ageChanged = (age) => {
    return {
        type: AGE_CHANGED,
        payload: age
    };
};
```

```js title="ãƒªãƒ‡ãƒ¥ãƒ¼ã‚µãƒ¼" 
switch (action.type) {
  case AGE_CHANGED:
      return { ...state, age: action.payload };
  default:
      return state;
}
```

</Step>

<Step>

```js title="ã‚¢ã‚¯ã‚·ãƒ§ãƒ³"
export const sexChanged = (sex) => {
    return {
        type: SEX_CHANGED,
        payload: sex
    };
};

export const ageChanged = (age) => {
    return {
        type: AGE_CHANGED,
        payload: age
    };
};
```

```js title="ãƒªãƒ‡ãƒ¥ãƒ¼ã‚µãƒ¼"
switch (action.type) {
  case SEX_CHANGED:
      return { ...state, male: action.payload };
  case AGE_CHANGED:
      return { ...state, age: action.payload };
  default:
      return state;
}
```

</Step>

<Step>

```js title="ã‚¢ã‚¯ã‚·ãƒ§ãƒ³"
export const sexChanged = (sex) => {
    return {
        type: SEX_CHANGED,
        payload: sex
    };
};

export const ageChanged = (age) => {
    return {
        type: AGE_CHANGED,
        payload: age
    };
};

export const regionChanged = (text) => {
    console.log(text)
    return {
        type: REGION_CHANGED,
        payload: text
    };
};

```

```js title="ãƒªãƒ‡ãƒ¥ãƒ¼ã‚µãƒ¼"
switch (action.type) {
  case SEX_CHANGED:
      return { ...state, male: action.payload };
  case AGE_CHANGED:
      return { ...state, age: action.payload };
  case REGION_CHANGED:
      return { ...state, region: action.payload };
  default:
      return state;
}
```

</Step>

<Step>

```js title="ã‚¢ã‚¯ã‚·ãƒ§ãƒ³"
export const sexChanged = (sex) => {
    return {
        type: SEX_CHANGED,
        payload: sex
    };
};

export const ageChanged = (age) => {
    return {
        type: AGE_CHANGED,
        payload: age
    };
};

export const regionChanged = (text) => {
    console.log(text)
    return {
        type: REGION_CHANGED,
        payload: text
    };
};

export const nameChanged = (text) => {
    return {
        type: NAME_CHANGED,
        payload: text
    };
};

export const profileChanged = (text) => {
    return {
        type: PROFILE_CHANGED,
        payload: text
    };
};

export const profileImageChanged = (image) => {
    return {
        type: PROFILEIMAGE_CHANGED,
        payload: image
    };
};

export const snackChanged = (text) => {
    return {
        type: SNACK_CHANGED,
        payload: text
    };
};
```

```js title="ãƒªãƒ‡ãƒ¥ãƒ¼ã‚µãƒ¼"
switch (action.type) {
  case SEX_CHANGED:
      return { ...state, male: action.payload };
  case AGE_CHANGED:
      return { ...state, age: action.payload };
  case REGION_CHANGED:
      return { ...state, region: action.payload };
  case NAME_CHANGED:
      return { ...state, name: action.payload };
  case PROFILE_CHANGED:
      return { ...state, profile: action.payload };
  case PROFILEIMAGE_CHANGED:
      return { ...state, profileImage: action.payload };
  case SNACK_CHANGED:
      return { ...state, snack: action.payload };
  case IMAGE_UPLOAD_START:
      return { ...state, imageUpoading: true};
  case IMAGE_UPLOAD_FINISH:
      return {...state, imageUploading: false}
  case PROFILE_FINISH:
      return {...state, updateLoading: true, imageUploading: true};
  case PROFILE_FINISH_SUCCESS:
      return {...state, updateLoading: false};
  case PROFILE_GET_FAIL:
      return {...state, loading:true}
  default:
      return state;
}
```

</Step>

</CodeSurferColumns>

---

<CodeSurfer>

```js
console.log(1);
console.log(2);
console.log(3);
```

```js 1
console.log(1);
console.log(2);
console.log(3);
```

```js
console.log(1);
console.log(2);
console.log(3);
console.log(4);
console.log(5);
```

</CodeSurfer>

---

<CodeSurfer>

```js title="ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ"
import React, { Component } from 'react';
import { connect } from 'react-redux';
import { withStyles } from '@material-ui/core/styles';
import Typography from '@material-ui/core/Typography';
import TextField from '@material-ui/core/TextField';
import CameraAlt from '@material-ui/icons/CameraAlt';
import { nameChanged, profileChanged, profileImageChanged, profileGet, profileFinish } from '../../actions';
// import Fab from '@material-ui/core/Fab';
import Button from '@material-ui/core/Button';
import CircularProgress from '@material-ui/core/CircularProgress';

const styles = theme => ({
    root: {
        display: 'flex',
        flexDirection: 'column',
        alignItems: 'center'
    },
    circularprogress :{
        marginTop: theme.spacing.unit * 20
    },
    nameform: {
        marginTop:  theme.spacing.unit * 2,
        width: 150,
    },
    textform: {
        marginTop:  theme.spacing.unit * 5,
        width: 300,
    },
    inputZone : {
        display: 'flex',
        flexDirection: 'column',
        justifyContent: 'center',
        alignItems: 'center',
        width: 160,
        height: 160,
        margin: '20px 0',
        border: `2px dashed ${theme.palette.grey[400]}`
    },
    inputZoneIntro: {
        display: 'flex',
        flexDirection: 'column',
        justifyContent: 'center',
        alignItems: 'center',
    },
    inputZoneOnImage : {
        display: 'flex',
        flexDirection: 'column',
        justifyContent: 'center',
        alignItems: 'center',
        width: 160,
        height: 160,
        margin: '20px 0',
        border: `1px ${theme.palette.grey[400]}`
    },
    imageZone : {
        display: 'flex',
        flexDirection: 'column',
        justifyContent: 'center',
        alignItems: 'center',
        // width: 160,
        height: 160,
    },
    icon: {
        fontSize: 80,
        color: theme.palette.grey[500]
      },
    font: {
        color: theme.palette.grey[500]
    },
    button: {
        marginTop: theme.spacing.unit * 3
    }
});

class Prof extends Component {
    state = {
        edit: false,
        imageUpdated: false
    }

    componentDidMount(){
        this.props.profileGet(this.props.user.uid)
    }

    onNameChange(text) {
        this.props.nameChanged(text.target.value);
    }

    onProfileChange(text) {
        this.props.profileChanged(text.target.value)
    }

    renderButton(){
        if(this.props.profile.updateLoading){
            return <CircularProgress size={30} className={this.props.classes.button} />
        }
        return this.state.edit && 
            <Button
                variant="outlined"
                onClick={this.handleFinish.bind(this)}
                className={this.props.classes.button}
                color="primary"
            >
                å®Œäº†ã™ã‚‹
            </Button>
        
    }

    handleChange(e){
        this.setState({
            imageUpdated: true
        });
        const files = e.target.files;
        if(files.length !== 0) {
            this.props.profileImageChanged(files[0])
        }
    }

    handleFinish(){
        const{male, age, region, name, profile, profileImage} = this.props.profile;

        this.props.profileFinish({male, age, region, name, profile, profileImage});
        this.setState({edit: !this.state.edit}) ;
    }

    render() {
        const { classes, profile } = this.props;
        const { profileImage } = profile;

        let img_src = profile.loading? "": profile.profileImageURL;
        let updated_image_src =  this.state.imageUpdated? URL.createObjectURL(profileImage):"";

        if(profile.loading){
            return (
                <div className={classes.root}>
                    <CircularProgress className={classes.circularprogress} size={60} />
                </div>
            )
        }
        return (
            <div
                className={classes.root}
            >
                <label className={profile.loading?classes.inputZone:classes.inputZoneOnImage}>
                    {profile.loading ? 
                        <div className={classes.inputZoneIntro}>
                        <CameraAlt className={classes.icon} />
                        <Typography variant="caption" className={classes.font}>å¿…é ˆ</Typography>
                        </div>:
                        <img className={classes.imageZone} alt="" src={this.state.imageUpdated ? updated_image_src :img_src} />
                    }
                    <input 
                        disabled={!this.state.edit}
                        type="file"
                        accept="image/*"
                        onChange={this.handleChange.bind(this)}
                        style={{display: 'none'}} 
                    />
                </label>
                
                <TextField
                    disabled={!this.state.edit}
                    className={classes.nameform}
                    label='åå‰'
                    value={profile.name}
                    onChange={this.onNameChange.bind(this)}
                    autoFocus
                />
                <TextField
                    disabled={!this.state.edit}
                    className={classes.textform}
                    id="outlined-multiline-flexible"
                    label='ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«'
                    multiline
                    onChange={this.onProfileChange.bind(this)}
                    value={this.props.profile.profile}
                    rows="8"
                    rowsMax="15"
                    margin="normal"
                    helperText="ä¾‹:ã‚®ã‚¿ãƒ¼ãŒå¥½ãã§ã™ï¼èº«é•·ã¯170cmã§ã™ï¼"
                    variant="outlined"
                />
                <Button
                    variant="outlined"
                    onClick={() => this.setState({
                        edit: !this.state.edit
                    })} 
                    className={classes.button}
                    color="default"
                >
                    {this.state.edit ? "ã‚­ãƒ£ãƒ³ã‚»ãƒ«" :"ç·¨é›†ã™ã‚‹"}
                </Button>
                {this.renderButton()}
            </div>
        );
    }
}

const mapStateToProps = state => {
    return {
        profile: state.profile,
        user: state.auth.user
    };
};

export default withStyles(styles)(
    connect(mapStateToProps, {
        nameChanged,
        profileChanged,
        profileImageChanged,
        profileGet,
        profileFinish
    })(
        Prof
));
```

```diff 199:214 subtitle="reduxã¨æ¥ç¶š"

```

```diff 199:204 subtitle="state"

```

```diff 208:212 subtitle="action"

```

</CodeSurfer>


---

### Reduxä½œè€…ã®Danæ°ã®ãƒ„ã‚¤ãƒ¼ãƒˆ

<Layout>

My biggest regret with Redux is explaining it in terms of API instead of how to â€œthink in itâ€.
(Reduxã¯**API**ã¨ã—ã¦ã§ãªãã€**è€ƒãˆæ–¹**ã¨ã—ã¦èª¬æ˜ã™ã‚‹ã¹ãã ã£ãŸ)

I underestimated the temptation to twist it into a familiar conceptual model â€” and that itâ€™s flexible enough to allow these contortions.
(Reduxã‚’è‡ªåˆ†ãŒçŸ¥ã£ã¦ã‚‹ã ã‘ã®æ¦‚å¿µã«ã“ã‚“ãªã«ã‚‚ç„¡ç†ã‚„ã‚Šçµã³ã¤ã‘ãŸãŒã‚‹ãªã‚“ã¦ã€æ€ã„ã‚‚ã—ãªã‹ã£ãŸã‚ˆ)
</Layout>

---

### Reduxä½œè€…ã®Danæ°ã®ãƒ„ã‚¤ãƒ¼ãƒˆ

<Layout>

If you copy paste some action creators and reducers handling FETCH actions over and over and over again, youâ€™re probably using Redux in a different way than I imagined people would do. 
(ã‚‚ã—ã‚‚ä½•åº¦ã‚‚åŒã˜ã‚ˆã†ãªFETCHã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã‚’ã‚³ãƒ”ãƒšã—ã¦ã‚‹ãªã‚‰ã€ãã‚“ãªãµã†ã«ä½¿ã‚ã‚Œã‚‹ãªã‚“ã¦æƒ³å®šã—ã¦ãªã‹ã£ãŸã‚“ã )

Iâ€™m sorry for all the repetitive code you felt you needed to write. Thatâ€™s my fault.
(ã‚‚ã—ã‚‚ç¹°ã‚Šè¿”ã—åŒã˜ã‚³ãƒ¼ãƒ‰ãŒæ›¸ã‹ã‚Œã¦ã‚‹ãªã‚‰ã€**ã‚³ãƒ¼ãƒ‰ãŸã¡**ã‚ˆã€ã»ã‚“ã¨ã”ã‚ã‚“ã€‚ä¿ºã®ã›ã„ã ã€‚)
</Layout>

---

# ğŸ˜‚

---

Reduxã‚’ç†è§£ã™ã‚‹ãŸã‚ã«è‡ªåˆ†ã§ã¤ãã£ã¦ã¿ã‚‹

---

<CodeSurfer>

```html title="Official Counter Sample"
<!DOCTYPE html>
<html>
  <head>
    <title>Redux basic example</title>
  </head>
  <body>
    <div>
      <p>
        Clicked: <span id="value">0</span> times
        <button id="increment">+</button>
        <button id="decrement">-</button>
        <button id="incrementIfOdd">Increment if odd</button>
        <button id="incrementAsync">Increment async</button>
      </p>
    </div>
    <script>
      function counter(state, action) {
        if (typeof state === 'undefined') {
          return 0
        }
        switch (action.type) {
          case 'INCREMENT':
            return state + 1
          case 'DECREMENT':
            return state - 1
          default:
            return state
        }
      }
      var store = Redux.createStore(counter)
      var valueEl = document.getElementById('value')
      function render() {
        valueEl.innerHTML = store.getState().toString()
      }
      render()
      store.subscribe(render)
      document.getElementById('increment')
        .addEventListener('click', function () {
          store.dispatch({ type: 'INCREMENT' })
        })
      document.getElementById('decrement')
        .addEventListener('click', function () {
          store.dispatch({ type: 'DECREMENT' })
        })
      document.getElementById('incrementIfOdd')
        .addEventListener('click', function () {
          if (store.getState() % 2 !== 0) {
            store.dispatch({ type: 'INCREMENT' })
          }
        })
      document.getElementById('incrementAsync')
        .addEventListener('click', function () {
          setTimeout(function () {
            store.dispatch({ type: 'INCREMENT' })
          }, 1000)
        })
    </script>
  </body>
</html>
```

```html subtitle="ã“ã“ã‚’è‡ªå‰å®Ÿè£…ã«å¤‰ãˆã‚‹"
<!DOCTYPE html>
<html>
  <head>
    <title>Redux basic example</title>
    <script src="https://unpkg.com/redux@latest/dist/redux.min.js"></script>
  </head>
  <body>
    <div>
      <p>
        Clicked: <span id="value">0</span> times
        <button id="increment">+</button>
        <button id="decrement">-</button>
        <button id="incrementIfOdd">Increment if odd</button>
        <button id="incrementAsync">Increment async</button>
      </p>
    </div>
    <script>
      function counter(state, action) {
        if (typeof state === 'undefined') {
          return 0
        }
        switch (action.type) {
          case 'INCREMENT':
            return state + 1
          case 'DECREMENT':
            return state - 1
          default:
            return state
        }
      }
      var store = Redux.createStore(counter)
      var valueEl = document.getElementById('value')
      function render() {
        valueEl.innerHTML = store.getState().toString()
      }
      render()
      store.subscribe(render)
      document.getElementById('increment')
        .addEventListener('click', function () {
          store.dispatch({ type: 'INCREMENT' })
        })
      document.getElementById('decrement')
        .addEventListener('click', function () {
          store.dispatch({ type: 'DECREMENT' })
        })
      document.getElementById('incrementIfOdd')
        .addEventListener('click', function () {
          if (store.getState() % 2 !== 0) {
            store.dispatch({ type: 'INCREMENT' })
          }
        })
      document.getElementById('incrementAsync')
        .addEventListener('click', function () {
          setTimeout(function () {
            store.dispatch({ type: 'INCREMENT' })
          }, 1000)
        })
    </script>
  </body>
</html>
```

```diff 31[19:44],34[29:45],37,40

```

```diff 31[19:44] subtitle="ã¾ãšã¯createStoreãƒ¡ã‚½ãƒƒãƒ‰ã‚’ã¤ãã£ã¦ã„ã"

```

</CodeSurfer>

---

<CodeSurferColumns themes={[vsDark, github]}>

<Step>

```js
const magna = aliqua => aliqua.ut((enim, ad) => enim, 0);
```

```js
const minim = (ad, enim) => dolore.magna(ad / enim);
```

</Step>

<Step>

```js
const lorem = (ipsum, dolor, sit) => {
  const amet = dolor - ipsum;
  return consectetur.adipiscing(
    {
      elit: sed.eiusmod(sit - dolor) / amet + 2,
    },
    (tempor, incididunt) => ipsum + amet * incididunt
  );
};

const magna = aliqua => aliqua.ut((enim, ad) => enim, 0);
```

```js
const minim = (ad, enim) => dolore.magna(ad / enim);

const sed = (eiusmod, tempor, incididunt) => {
  const ut = tempor - eiusmod;
  return labore.et(
    {
      amet: dolore.magna(incididunt - tempor) / ut + 2,
    },
    (aliqua, elit) => eiusmod + ut * elit
  );
};
```

</Step>

</CodeSurferColumns>

---

docs:  
[codesurfer.pomb.us](https://codesurfer.pomb.us)

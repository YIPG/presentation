import {
  CodeSurfer,
  CodeSurferColumns,
  Step,
} from "code-surfer";
import { github, vsDark } from "@code-surfer/themes";
import { Layout } from "./Layout";

export const theme = vsDark;

# ゼロから理解するRedux

---

# 自己紹介

- 伊藤友哉
- 東工大B5 (あ。。。)
- 2018/9からReact&プログラミング始めた
- twitter: [@yuyaito_hoge](https://twitter.com/yuyaito_hoge)

---

Redux...使っていますか?

---

Redux とは

<iframe
  style={{
    width: "90vw",
    height: "75vh",
    background: "white",
  }}
  src={"https://redux.js.org/"}
></iframe>

---

# Pros

1. テスタビリティが高い
1. 開発者が増えてもコンフリクトが起きづらい
1. Contextネスト地獄, Propsバケツリレー地獄が消える

---

# Cons

1. コードが冗長になりがち
1. 書いてて楽しくない()

---

よくあるコード

---

<CodeSurferColumns themes={[vsDark, github]}>

<Step>

```js title="アクション"
export const ageChanged = (age) => {
    return {
        type: AGE_CHANGED,
        payload: age
    };
};
```

```js title="リデューサー" 
switch (action.type) {
  case AGE_CHANGED:
      return { ...state, age: action.payload };
  default:
      return state;
}
```

</Step>

<Step>

```js title="アクション"
export const sexChanged = (sex) => {
    return {
        type: SEX_CHANGED,
        payload: sex
    };
};

export const ageChanged = (age) => {
    return {
        type: AGE_CHANGED,
        payload: age
    };
};
```

```js title="リデューサー"
switch (action.type) {
  case SEX_CHANGED:
      return { ...state, male: action.payload };
  case AGE_CHANGED:
      return { ...state, age: action.payload };
  default:
      return state;
}
```

</Step>

<Step>

```js title="アクション"
export const sexChanged = (sex) => {
    return {
        type: SEX_CHANGED,
        payload: sex
    };
};

export const ageChanged = (age) => {
    return {
        type: AGE_CHANGED,
        payload: age
    };
};

export const regionChanged = (text) => {
    console.log(text)
    return {
        type: REGION_CHANGED,
        payload: text
    };
};

```

```js title="リデューサー"
switch (action.type) {
  case SEX_CHANGED:
      return { ...state, male: action.payload };
  case AGE_CHANGED:
      return { ...state, age: action.payload };
  case REGION_CHANGED:
      return { ...state, region: action.payload };
  default:
      return state;
}
```

</Step>

<Step>

```js title="アクション"
export const sexChanged = (sex) => {
    return {
        type: SEX_CHANGED,
        payload: sex
    };
};

export const ageChanged = (age) => {
    return {
        type: AGE_CHANGED,
        payload: age
    };
};

export const regionChanged = (text) => {
    console.log(text)
    return {
        type: REGION_CHANGED,
        payload: text
    };
};

export const nameChanged = (text) => {
    return {
        type: NAME_CHANGED,
        payload: text
    };
};

export const profileChanged = (text) => {
    return {
        type: PROFILE_CHANGED,
        payload: text
    };
};

export const profileImageChanged = (image) => {
    return {
        type: PROFILEIMAGE_CHANGED,
        payload: image
    };
};

export const snackChanged = (text) => {
    return {
        type: SNACK_CHANGED,
        payload: text
    };
};
```

```js title="リデューサー"
switch (action.type) {
  case SEX_CHANGED:
      return { ...state, male: action.payload };
  case AGE_CHANGED:
      return { ...state, age: action.payload };
  case REGION_CHANGED:
      return { ...state, region: action.payload };
  case NAME_CHANGED:
      return { ...state, name: action.payload };
  case PROFILE_CHANGED:
      return { ...state, profile: action.payload };
  case PROFILEIMAGE_CHANGED:
      return { ...state, profileImage: action.payload };
  case SNACK_CHANGED:
      return { ...state, snack: action.payload };
  case IMAGE_UPLOAD_START:
      return { ...state, imageUpoading: true};
  case IMAGE_UPLOAD_FINISH:
      return {...state, imageUploading: false}
  case PROFILE_FINISH:
      return {...state, updateLoading: true, imageUploading: true};
  case PROFILE_FINISH_SUCCESS:
      return {...state, updateLoading: false};
  case PROFILE_GET_FAIL:
      return {...state, loading:true}
  default:
      return state;
}
```

</Step>

</CodeSurferColumns>

---

# なんか冗長😢

---

### Redux作者のDan氏のツイート

<Layout>

My biggest regret with Redux is explaining it in terms of API instead of how to “think in it”.
(Reduxは**API**としてでなく、**考え方**として説明するべきだった)

I underestimated the temptation to twist it into a familiar conceptual model — and that it’s flexible enough to allow these contortions.
(Reduxを自分が知ってるだけの概念にこんなにも無理やり結びつけたがるなんて、思いもしなかったよ)

[ソース](https://twitter.com/dan_abramov/status/1039570011986321408)
</Layout>

---

### Redux作者のDan氏のツイート

<Layout>

If you copy paste some action creators and reducers handling FETCH actions over and over and over again, you’re probably using Redux in a different way than I imagined people would do. 
(もしも何度も同じようなFETCHアクションをコピペしてるなら、そんなふうに使われるなんて想定してなかったんだ)

I’m sorry for all the repetitive code you felt you needed to write. That’s my fault.
(もしも繰り返し同じコードが書かれてるなら、**コードたち**よ、ほんとごめん。俺のせいだ。)

[ソース](https://twitter.com/dan_abramov/status/1039584557702553601)
</Layout>

---

# 😂

---

### Reduxを理解するために自分でつくってみる

ソース(https://github.com/reduxjs/redux/blob/master/examples/counter-vanilla/index.html)

---

<CodeSurfer>

```html title="Official Counter Sample"
<!DOCTYPE html>
<html>
  <head>
    <title>Redux basic example</title>
  </head>
  <body>
    <div>
      <p>
        Clicked: <span id="value">0</span> times
        <button id="increment">+</button>
        <button id="decrement">-</button>
        <button id="incrementIfOdd">Increment if odd</button>
        <button id="incrementAsync">Increment async</button>
      </p>
    </div>
    <script>
      function counter(state, action) {
        if (typeof state === 'undefined') {
          return 0
        }
        switch (action.type) {
          case 'INCREMENT':
            return state + 1
          case 'DECREMENT':
            return state - 1
          default:
            return state
        }
      }
      var store = Redux.createStore(counter)
      var valueEl = document.getElementById('value')
      function render() {
        valueEl.innerHTML = store.getState().toString()
      }
      render()
      store.subscribe(render)
      document.getElementById('increment')
        .addEventListener('click', function () {
          store.dispatch({ type: 'INCREMENT' })
        })
      document.getElementById('decrement')
        .addEventListener('click', function () {
          store.dispatch({ type: 'DECREMENT' })
        })
      document.getElementById('incrementIfOdd')
        .addEventListener('click', function () {
          if (store.getState() % 2 !== 0) {
            store.dispatch({ type: 'INCREMENT' })
          }
        })
      document.getElementById('incrementAsync')
        .addEventListener('click', function () {
          setTimeout(function () {
            store.dispatch({ type: 'INCREMENT' })
          }, 1000)
        })
    </script>
  </body>
</html>
```

```html subtitle="ここを自前実装に変える"
<!DOCTYPE html>
<html>
  <head>
    <title>Redux basic example</title>
    <script src="https://unpkg.com/redux@latest/dist/redux.min.js"></script>
  </head>
  <body>
    <div>
      <p>
        Clicked: <span id="value">0</span> times
        <button id="increment">+</button>
        <button id="decrement">-</button>
        <button id="incrementIfOdd">Increment if odd</button>
        <button id="incrementAsync">Increment async</button>
      </p>
    </div>
    <script>
      function counter(state, action) {
        if (typeof state === 'undefined') {
          return 0
        }
        switch (action.type) {
          case 'INCREMENT':
            return state + 1
          case 'DECREMENT':
            return state - 1
          default:
            return state
        }
      }
      var store = Redux.createStore(counter)
      var valueEl = document.getElementById('value')
      function render() {
        valueEl.innerHTML = store.getState().toString()
      }
      render()
      store.subscribe(render)
      document.getElementById('increment')
        .addEventListener('click', function () {
          store.dispatch({ type: 'INCREMENT' })
        })
      document.getElementById('decrement')
        .addEventListener('click', function () {
          store.dispatch({ type: 'DECREMENT' })
        })
      document.getElementById('incrementIfOdd')
        .addEventListener('click', function () {
          if (store.getState() % 2 !== 0) {
            store.dispatch({ type: 'INCREMENT' })
          }
        })
      document.getElementById('incrementAsync')
        .addEventListener('click', function () {
          setTimeout(function () {
            store.dispatch({ type: 'INCREMENT' })
          }, 1000)
        })
    </script>
  </body>
</html>
```

```diff 31[19:44],34[29:45],37,40 title="今回実装するRedux関連メソッドたち"

```

```diff 18:30 title="Reducer" subtitle="ReducerはピュアなJavascriptです"

```

```diff 31 title="createStore" subtitle="createStoreはreducerを受け取りstoreを返します"

```

```diff 34[29:44] title="getState" subtitle="getStateは現在のstate値を返します"

```

```diff 34[29:44],18:30 subtitle="stateはreducer内で定義されている"

```

```diff 37 title="subscribe" subtitle="subscribeはstateが更新されるごとにrenderを発火させます"

```

```diff 37,33:35 title="render"

```

```diff 37,32:35 title="render" subtitle="renderはstate値をid="value"を持つDOM要素に書き込みます"

```

```diff 40 title="dispatch" subtitle="dispatchはactionをreducerに渡します"

```

```diff 31[19:44],34[29:45],37,40 title="今回実装するRedux関連メソッドたち"

```

```diff 31[19:44],34[29:45],37,40 title="今回実装するRedux関連メソッドたち" subtitle="ここからは実際にコードを書いていきます"

```

</CodeSurfer>

---

Coding...👨‍💻

---

## まとめ
- Reduxのもっともシンプルな実装をしました
- Reduxと仲良くなれた気がしました😎

---

ありがとうございました🙏